name: Build and Deploy
on: [push]
jobs:
  build-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Debug Environment
        run: |
          echo "Runner OS: $env:RUNNER_OS"
          echo "Docker version: $(docker --version)"
          echo "kubectl version: $(kubectl version --client --short)"

      - name: Validate Secrets Exist
        run: |
          if (-not "${{ secrets.DOCKER_USERNAME }}") { 
            echo "ERROR: DOCKER_USERNAME secret is empty!" 
            exit 1
          }
          echo "DOCKER_USERNAME secret exists (value hidden for security)"
          echo "DOCKER_PASSWORD secret exists (value hidden for security)"

      - name: Clean Docker Config
        run: |
          Remove-Item -Path ~/.docker/config.json -ErrorAction SilentlyContinue
          echo "Cleared any existing Docker credentials"

      - name: Log in to Docker Hub
        run: |
          $loginOutput = $(echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" docker.io --password-stdin 2>&1)
          if ($LASTEXITCODE -ne 0) {
            echo "Docker login failed with output:"
            echo $loginOutput
            echo "Troubleshooting:"
            echo "1. Verify Docker Hub token has 'Read & Write' permissions"
            echo "2. Check for special characters in credentials"
            echo "3. Ensure secrets are properly set in GitHub"
            exit 1
          }
          echo "Docker login succeeded"

      - name: Build and Push Docker Image
        run: |
          docker build -t faizz209/my-app:latest .
          docker push faizz209/my-app:latest
          echo "Successfully built and pushed image"

      - name: Deploy to Minikube
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          echo "Current deployments:"
          kubectl get deployments
          echo "Current pods:"
          kubectl get pods